import { Component, ElementRef, Injectable, Input, Renderer2, ViewChild, ViewEncapsulation, } from "@angular/core";
import { MdlError } from "../common/mdl-error";
import * as i0 from "@angular/core";
const BOTTOM_LEFT = "bottom-left";
const BOTTOM_RIGHT = "bottom-right";
const TOP_LEFT = "top-left";
const TOP_RIGHT = "top-right";
const UNALIGNED = "unaligned";
// Total duration of the menu animation.
const TRANSITION_DURATION_SECONDS = 0.3;
// The fraction of the total duration we want to use for menu item animations.
const TRANSITION_DURATION_FRACTION = 0.8;
// How long the menu stays open after choosing an option (so the user can see
// the ripple).
const CLOSE_TIMEOUT = 175;
const CSS_ALIGN_MAP = {};
CSS_ALIGN_MAP[BOTTOM_LEFT] = "mdl-menu--bottom-left";
CSS_ALIGN_MAP[BOTTOM_RIGHT] = "mdl-menu--bottom-right";
CSS_ALIGN_MAP[TOP_LEFT] = "mdl-menu--top-left";
CSS_ALIGN_MAP[TOP_RIGHT] = "mdl-menu--top-right";
CSS_ALIGN_MAP[UNALIGNED] = "mdl-menu--unaligned";
export class MdlMenuError extends MdlError {
}
export class MdlMenuRegisty {
    constructor() {
        this.menuComponents = [];
    }
    add(menuComponent) {
        this.menuComponents.push(menuComponent);
    }
    remove(menuComponent) {
        const fromIndex = this.menuComponents.indexOf(menuComponent);
        this.menuComponents.splice(fromIndex, 1);
    }
    hideAllExcept(menuComponent) {
        this.menuComponents.forEach((component) => {
            if (component !== menuComponent) {
                component.hide();
            }
        });
    }
}
MdlMenuRegisty.ɵprov = i0.ɵɵdefineInjectable({ factory: function MdlMenuRegisty_Factory() { return new MdlMenuRegisty(); }, token: MdlMenuRegisty, providedIn: "root" });
MdlMenuRegisty.decorators = [
    { type: Injectable, args: [{
                providedIn: "root",
            },] }
];
export class MdlMenuComponent {
    constructor(renderer, menuRegistry) {
        this.renderer = renderer;
        this.menuRegistry = menuRegistry;
        this.cssPosition = "mdl-menu--bottom-left";
        this.isVisible = false;
        this.menuRegistry.add(this);
    }
    ngOnInit() {
        this.cssPosition = CSS_ALIGN_MAP[this.position] || BOTTOM_LEFT;
    }
    ngAfterViewInit() {
        this.container = this.containerChild.nativeElement;
        this.menuElement = this.menuElementChild.nativeElement;
        this.outline = this.outlineChild.nativeElement;
        // Add a click listener to the document, to close the menu.
        const callback = () => {
            if (this.isVisible) {
                this.hide();
            }
            return true;
        };
        this.renderer.listen("window", "click", callback);
        this.renderer.listen("window", "touchstart", callback);
    }
    toggle(event, mdlButton) {
        if (!mdlButton) {
            throw new MdlMenuError(`MdlButtonComponent is required`);
        }
        if (this.isVisible) {
            this.hide();
        }
        else {
            this.show(event, mdlButton);
        }
    }
    hideOnItemClicked() {
        // Wait some time before closing menu, so the user can see the ripple.
        setTimeout(() => {
            this.hide();
        }, CLOSE_TIMEOUT);
    }
    hide() {
        // Remove all transition delays; menu items fade out concurrently.
        document.querySelectorAll("mdl-menu-item").forEach((el) => {
            el.style.removeProperty("transition-delay");
        });
        // this.menuItemComponents.toArray().forEach(mi => {
        //   mi.element.style.removeProperty('transition-delay');
        // });
        // Measure the inner element.
        const rect = this.menuElement.getBoundingClientRect();
        const height = rect.height;
        const width = rect.width;
        // Turn on animation, and apply the final clip. Also make invisible.
        // This triggers the transitions.
        this.renderer.addClass(this.menuElement, "is-animating");
        this.applyClip(height, width);
        this.renderer.removeClass(this.container, "is-visible");
        // Clean up after the animation is complete.
        this.addAnimationEndListener();
        this.isVisible = false;
    }
    show(event, mdlButton) {
        this.menuRegistry.hideAllExcept(this);
        event.stopPropagation();
        const forElement = mdlButton.element;
        const rect = forElement.getBoundingClientRect();
        const forRect = forElement.parentElement.getBoundingClientRect();
        if (this.position === UNALIGNED) {
            // Do not position the menu automatically. Requires the developer to
            // manually specify position.
        }
        else if (this.position === BOTTOM_RIGHT) {
            // Position below the "for" element, aligned to its right.
            this.container.style.right = forRect.right - rect.right + "px";
            this.container.style.top =
                forElement.offsetTop + forElement.offsetHeight + "px";
        }
        else if (this.position === TOP_LEFT) {
            // Position above the "for" element, aligned to its left.
            this.container.style.left = forElement.offsetLeft + "px";
            this.container.style.bottom = forRect.bottom - rect.top + "px";
        }
        else if (this.position === TOP_RIGHT) {
            // Position above the "for" element, aligned to its right.
            this.container.style.right = forRect.right - rect.right + "px";
            this.container.style.bottom = forRect.bottom - rect.top + "px";
        }
        else {
            // Default: position below the "for" element, aligned to its left.
            this.container.style.left = forElement.offsetLeft + "px";
            this.container.style.top =
                forElement.offsetTop + forElement.offsetHeight + "px";
        }
        // Measure the inner element.
        const height = this.menuElement.getBoundingClientRect().height;
        const width = this.menuElement.getBoundingClientRect().width;
        this.container.style.width = width + "px";
        this.container.style.height = height + "px";
        this.outline.style.width = width + "px";
        this.outline.style.height = height + "px";
        const transitionDuration = TRANSITION_DURATION_SECONDS * TRANSITION_DURATION_FRACTION;
        document.querySelectorAll("mdl-menu-item").forEach((el) => {
            const mi = el;
            let itemDelay;
            if (this.position === TOP_LEFT || this.position === TOP_RIGHT) {
                itemDelay =
                    ((height - mi.offsetTop - mi.offsetHeight) / height) *
                        transitionDuration +
                        "s";
            }
            else {
                itemDelay = (mi.offsetTop / height) * transitionDuration + "s";
            }
            mi.style.transitionDelay = itemDelay;
        });
        // Apply the initial clip to the text before we start animating.
        this.applyClip(height, width);
        this.renderer.addClass(this.container, "is-visible");
        this.menuElement.style.clip = "rect(0 " + width + "px " + height + "px 0)";
        this.renderer.addClass(this.menuElement, "is-animating");
        this.addAnimationEndListener();
        this.isVisible = true;
    }
    ngOnDestroy() {
        this.menuRegistry.remove(this);
    }
    addAnimationEndListener() {
        this.renderer.listen(this.menuElement, "transitionend", () => {
            this.renderer.removeClass(this.menuElement, "is-animating");
            return true;
        });
    }
    applyClip(height, width) {
        if (this.position === UNALIGNED) {
            // Do not clip.
            this.menuElement.style.clip = "";
        }
        else if (this.position === BOTTOM_RIGHT) {
            // Clip to the top right corner of the menu.
            this.menuElement.style.clip =
                "rect(0 " + width + "px " + "0 " + width + "px)";
        }
        else if (this.position === TOP_LEFT) {
            // Clip to the bottom left corner of the menu.
            this.menuElement.style.clip =
                "rect(" + height + "px 0 " + height + "px 0)";
        }
        else if (this.position === TOP_RIGHT) {
            // Clip to the bottom right corner of the menu.
            this.menuElement.style.clip =
                "rect(" +
                    height +
                    "px " +
                    width +
                    "px " +
                    height +
                    "px " +
                    width +
                    "px)";
        }
        else {
            // Default: do not clip (same as clipping to the top left corner).
            this.menuElement.style.clip = "";
        }
    }
}
MdlMenuComponent.decorators = [
    { type: Component, args: [{
                selector: "mdl-menu",
                exportAs: "mdlMenu",
                template: `
    <div #container class="mdl-menu__container is-upgraded">
      <div #outline class="mdl-menu__outline" [ngClass]="cssPosition"></div>
      <div class="mdl-menu" #menuElement>
        <ng-content></ng-content>
      </div>
    </div>
  `,
                encapsulation: ViewEncapsulation.None
            },] }
];
MdlMenuComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: MdlMenuRegisty }
];
MdlMenuComponent.propDecorators = {
    position: [{ type: Input, args: ['mdl-menu-position',] }],
    containerChild: [{ type: ViewChild, args: ["container", { static: true },] }],
    menuElementChild: [{ type: ViewChild, args: ["menuElement", { static: true },] }],
    outlineChild: [{ type: ViewChild, args: ["outline", { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWRsLW1lbnUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvY29yZS9zcmMvbGliL21lbnUvbWRsLW1lbnUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFVBQVUsRUFDVixLQUFLLEVBR0wsU0FBUyxFQUNULFNBQVMsRUFDVCxpQkFBaUIsR0FDbEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHFCQUFxQixDQUFDOztBQUcvQyxNQUFNLFdBQVcsR0FBRyxhQUFhLENBQUM7QUFDbEMsTUFBTSxZQUFZLEdBQUcsY0FBYyxDQUFDO0FBQ3BDLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQztBQUM1QixNQUFNLFNBQVMsR0FBRyxXQUFXLENBQUM7QUFDOUIsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDO0FBRTlCLHdDQUF3QztBQUN4QyxNQUFNLDJCQUEyQixHQUFHLEdBQUcsQ0FBQztBQUN4Qyw4RUFBOEU7QUFDOUUsTUFBTSw0QkFBNEIsR0FBRyxHQUFHLENBQUM7QUFDekMsNkVBQTZFO0FBQzdFLGVBQWU7QUFDZixNQUFNLGFBQWEsR0FBRyxHQUFHLENBQUM7QUFFMUIsTUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDO0FBQ3pCLGFBQWEsQ0FBQyxXQUFXLENBQUMsR0FBRyx1QkFBdUIsQ0FBQztBQUNyRCxhQUFhLENBQUMsWUFBWSxDQUFDLEdBQUcsd0JBQXdCLENBQUM7QUFDdkQsYUFBYSxDQUFDLFFBQVEsQ0FBQyxHQUFHLG9CQUFvQixDQUFDO0FBQy9DLGFBQWEsQ0FBQyxTQUFTLENBQUMsR0FBRyxxQkFBcUIsQ0FBQztBQUNqRCxhQUFhLENBQUMsU0FBUyxDQUFDLEdBQUcscUJBQXFCLENBQUM7QUFFakQsTUFBTSxPQUFPLFlBQWEsU0FBUSxRQUFRO0NBQUc7QUFLN0MsTUFBTSxPQUFPLGNBQWM7SUFIM0I7UUFJRSxtQkFBYyxHQUF1QixFQUFFLENBQUM7S0FrQnpDO0lBaEJDLEdBQUcsQ0FBQyxhQUErQjtRQUNqQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRUQsTUFBTSxDQUFDLGFBQStCO1FBQ3BDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQsYUFBYSxDQUFDLGFBQStCO1FBQzNDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUU7WUFDeEMsSUFBSSxTQUFTLEtBQUssYUFBYSxFQUFFO2dCQUMvQixTQUFTLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDbEI7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Ozs7WUFyQkYsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COztBQW1DRCxNQUFNLE9BQU8sZ0JBQWdCO0lBa0IzQixZQUNVLFFBQW1CLEVBQ25CLFlBQTRCO1FBRDVCLGFBQVEsR0FBUixRQUFRLENBQVc7UUFDbkIsaUJBQVksR0FBWixZQUFZLENBQWdCO1FBUi9CLGdCQUFXLEdBQUcsdUJBQXVCLENBQUM7UUFJckMsY0FBUyxHQUFHLEtBQUssQ0FBQztRQU14QixJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM5QixDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksQ0FBQyxXQUFXLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxXQUFXLENBQUM7SUFDakUsQ0FBQztJQUVELGVBQWU7UUFDYixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDO1FBQ25ELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQztRQUN2RCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDO1FBRS9DLDJEQUEyRDtRQUMzRCxNQUFNLFFBQVEsR0FBRyxHQUFHLEVBQUU7WUFDcEIsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNsQixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDYjtZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQyxDQUFDO1FBQ0YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNsRCxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFRCxNQUFNLENBQUMsS0FBWSxFQUFFLFNBQTZCO1FBQ2hELElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxNQUFNLElBQUksWUFBWSxDQUFDLGdDQUFnQyxDQUFDLENBQUM7U0FDMUQ7UUFDRCxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbEIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ2I7YUFBTTtZQUNMLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1NBQzdCO0lBQ0gsQ0FBQztJQUVELGlCQUFpQjtRQUNmLHNFQUFzRTtRQUN0RSxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ2QsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2QsQ0FBQyxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQ3BCLENBQUM7SUFFRCxJQUFJO1FBQ0Ysa0VBQWtFO1FBQ2xFLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRTtZQUN2RCxFQUFrQixDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUMvRCxDQUFDLENBQUMsQ0FBQztRQUNILG9EQUFvRDtRQUNwRCx5REFBeUQ7UUFDekQsTUFBTTtRQUVOLDZCQUE2QjtRQUM3QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDdEQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUMzQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRXpCLG9FQUFvRTtRQUNwRSxpQ0FBaUM7UUFDakMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztRQUM5QixJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBRXhELDRDQUE0QztRQUM1QyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUUvQixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztJQUN6QixDQUFDO0lBRUQsSUFBSSxDQUFDLEtBQVksRUFBRSxTQUE2QjtRQUM5QyxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV0QyxLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFeEIsTUFBTSxVQUFVLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQztRQUNyQyxNQUFNLElBQUksR0FBRyxVQUFVLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUNoRCxNQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFFakUsSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLFNBQVMsRUFBRTtZQUMvQixvRUFBb0U7WUFDcEUsNkJBQTZCO1NBQzlCO2FBQU0sSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLFlBQVksRUFBRTtZQUN6QywwREFBMEQ7WUFDMUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7WUFDL0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRztnQkFDdEIsVUFBVSxDQUFDLFNBQVMsR0FBRyxVQUFVLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztTQUN6RDthQUFNLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxRQUFRLEVBQUU7WUFDckMseURBQXlEO1lBQ3pELElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztZQUN6RCxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQztTQUNoRTthQUFNLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxTQUFTLEVBQUU7WUFDdEMsMERBQTBEO1lBQzFELElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1lBQy9ELElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDO1NBQ2hFO2FBQU07WUFDTCxrRUFBa0U7WUFDbEUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1lBQ3pELElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUc7Z0JBQ3RCLFVBQVUsQ0FBQyxTQUFTLEdBQUcsVUFBVSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7U0FDekQ7UUFFRCw2QkFBNkI7UUFDN0IsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLE1BQU0sQ0FBQztRQUMvRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLHFCQUFxQixFQUFFLENBQUMsS0FBSyxDQUFDO1FBRTdELElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQzFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBQzVDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ3hDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBRTFDLE1BQU0sa0JBQWtCLEdBQ3RCLDJCQUEyQixHQUFHLDRCQUE0QixDQUFDO1FBQzdELFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRTtZQUN4RCxNQUFNLEVBQUUsR0FBRyxFQUFpQixDQUFDO1lBQzdCLElBQUksU0FBUyxDQUFDO1lBQ2QsSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLFFBQVEsSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLFNBQVMsRUFBRTtnQkFDN0QsU0FBUztvQkFDUCxDQUFDLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxHQUFHLE1BQU0sQ0FBQzt3QkFDbEQsa0JBQWtCO3dCQUNwQixHQUFHLENBQUM7YUFDUDtpQkFBTTtnQkFDTCxTQUFTLEdBQUcsQ0FBQyxFQUFFLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxHQUFHLGtCQUFrQixHQUFHLEdBQUcsQ0FBQzthQUNoRTtZQUNELEVBQUUsQ0FBQyxLQUFLLENBQUMsZUFBZSxHQUFHLFNBQVMsQ0FBQztRQUN2QyxDQUFDLENBQUMsQ0FBQztRQUVILGdFQUFnRTtRQUNoRSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztRQUU5QixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxTQUFTLEdBQUcsS0FBSyxHQUFHLEtBQUssR0FBRyxNQUFNLEdBQUcsT0FBTyxDQUFDO1FBQzNFLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFFekQsSUFBSSxDQUFDLHVCQUF1QixFQUFFLENBQUM7UUFFL0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7SUFDeEIsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRU8sdUJBQXVCO1FBQzdCLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsZUFBZSxFQUFFLEdBQUcsRUFBRTtZQUMzRCxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLGNBQWMsQ0FBQyxDQUFDO1lBQzVELE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sU0FBUyxDQUFDLE1BQU0sRUFBRSxLQUFLO1FBQzdCLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxTQUFTLEVBQUU7WUFDL0IsZUFBZTtZQUNmLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7U0FDbEM7YUFBTSxJQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssWUFBWSxFQUFFO1lBQ3pDLDRDQUE0QztZQUM1QyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxJQUFJO2dCQUN6QixTQUFTLEdBQUcsS0FBSyxHQUFHLEtBQUssR0FBRyxJQUFJLEdBQUcsS0FBSyxHQUFHLEtBQUssQ0FBQztTQUNwRDthQUFNLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxRQUFRLEVBQUU7WUFDckMsOENBQThDO1lBQzlDLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLElBQUk7Z0JBQ3pCLE9BQU8sR0FBRyxNQUFNLEdBQUcsT0FBTyxHQUFHLE1BQU0sR0FBRyxPQUFPLENBQUM7U0FDakQ7YUFBTSxJQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssU0FBUyxFQUFFO1lBQ3RDLCtDQUErQztZQUMvQyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxJQUFJO2dCQUN6QixPQUFPO29CQUNQLE1BQU07b0JBQ04sS0FBSztvQkFDTCxLQUFLO29CQUNMLEtBQUs7b0JBQ0wsTUFBTTtvQkFDTixLQUFLO29CQUNMLEtBQUs7b0JBQ0wsS0FBSyxDQUFDO1NBQ1Q7YUFBTTtZQUNMLGtFQUFrRTtZQUNsRSxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1NBQ2xDO0lBQ0gsQ0FBQzs7O1lBbE5GLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsVUFBVTtnQkFDcEIsUUFBUSxFQUFFLFNBQVM7Z0JBQ25CLFFBQVEsRUFBRTs7Ozs7OztHQU9UO2dCQUNELGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJO2FBQ3RDOzs7WUFsRUMsU0FBUztZQXVGZSxjQUFjOzs7dUJBbEJyQyxLQUFLLFNBQUMsbUJBQW1COzZCQUd6QixTQUFTLFNBQUMsV0FBVyxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTsrQkFFdkMsU0FBUyxTQUFDLGFBQWEsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7MkJBRXpDLFNBQVMsU0FBQyxTQUFTLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBJbmplY3RhYmxlLFxuICBJbnB1dCxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIFJlbmRlcmVyMixcbiAgVmlld0NoaWxkLFxuICBWaWV3RW5jYXBzdWxhdGlvbixcbn0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IE1kbEVycm9yIH0gZnJvbSBcIi4uL2NvbW1vbi9tZGwtZXJyb3JcIjtcbmltcG9ydCB7IE1kbEJ1dHRvbkNvbXBvbmVudCB9IGZyb20gXCIuLi9idXR0b24vbWRsLWJ1dHRvbi5jb21wb25lbnRcIjtcblxuY29uc3QgQk9UVE9NX0xFRlQgPSBcImJvdHRvbS1sZWZ0XCI7XG5jb25zdCBCT1RUT01fUklHSFQgPSBcImJvdHRvbS1yaWdodFwiO1xuY29uc3QgVE9QX0xFRlQgPSBcInRvcC1sZWZ0XCI7XG5jb25zdCBUT1BfUklHSFQgPSBcInRvcC1yaWdodFwiO1xuY29uc3QgVU5BTElHTkVEID0gXCJ1bmFsaWduZWRcIjtcblxuLy8gVG90YWwgZHVyYXRpb24gb2YgdGhlIG1lbnUgYW5pbWF0aW9uLlxuY29uc3QgVFJBTlNJVElPTl9EVVJBVElPTl9TRUNPTkRTID0gMC4zO1xuLy8gVGhlIGZyYWN0aW9uIG9mIHRoZSB0b3RhbCBkdXJhdGlvbiB3ZSB3YW50IHRvIHVzZSBmb3IgbWVudSBpdGVtIGFuaW1hdGlvbnMuXG5jb25zdCBUUkFOU0lUSU9OX0RVUkFUSU9OX0ZSQUNUSU9OID0gMC44O1xuLy8gSG93IGxvbmcgdGhlIG1lbnUgc3RheXMgb3BlbiBhZnRlciBjaG9vc2luZyBhbiBvcHRpb24gKHNvIHRoZSB1c2VyIGNhbiBzZWVcbi8vIHRoZSByaXBwbGUpLlxuY29uc3QgQ0xPU0VfVElNRU9VVCA9IDE3NTtcblxuY29uc3QgQ1NTX0FMSUdOX01BUCA9IHt9O1xuQ1NTX0FMSUdOX01BUFtCT1RUT01fTEVGVF0gPSBcIm1kbC1tZW51LS1ib3R0b20tbGVmdFwiO1xuQ1NTX0FMSUdOX01BUFtCT1RUT01fUklHSFRdID0gXCJtZGwtbWVudS0tYm90dG9tLXJpZ2h0XCI7XG5DU1NfQUxJR05fTUFQW1RPUF9MRUZUXSA9IFwibWRsLW1lbnUtLXRvcC1sZWZ0XCI7XG5DU1NfQUxJR05fTUFQW1RPUF9SSUdIVF0gPSBcIm1kbC1tZW51LS10b3AtcmlnaHRcIjtcbkNTU19BTElHTl9NQVBbVU5BTElHTkVEXSA9IFwibWRsLW1lbnUtLXVuYWxpZ25lZFwiO1xuXG5leHBvcnQgY2xhc3MgTWRsTWVudUVycm9yIGV4dGVuZHMgTWRsRXJyb3Ige31cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiBcInJvb3RcIixcbn0pXG5leHBvcnQgY2xhc3MgTWRsTWVudVJlZ2lzdHkge1xuICBtZW51Q29tcG9uZW50czogTWRsTWVudUNvbXBvbmVudFtdID0gW107XG5cbiAgYWRkKG1lbnVDb21wb25lbnQ6IE1kbE1lbnVDb21wb25lbnQpOiB2b2lkIHtcbiAgICB0aGlzLm1lbnVDb21wb25lbnRzLnB1c2gobWVudUNvbXBvbmVudCk7XG4gIH1cblxuICByZW1vdmUobWVudUNvbXBvbmVudDogTWRsTWVudUNvbXBvbmVudCk6IHZvaWQge1xuICAgIGNvbnN0IGZyb21JbmRleCA9IHRoaXMubWVudUNvbXBvbmVudHMuaW5kZXhPZihtZW51Q29tcG9uZW50KTtcbiAgICB0aGlzLm1lbnVDb21wb25lbnRzLnNwbGljZShmcm9tSW5kZXgsIDEpO1xuICB9XG5cbiAgaGlkZUFsbEV4Y2VwdChtZW51Q29tcG9uZW50OiBNZGxNZW51Q29tcG9uZW50KTogdm9pZCB7XG4gICAgdGhpcy5tZW51Q29tcG9uZW50cy5mb3JFYWNoKChjb21wb25lbnQpID0+IHtcbiAgICAgIGlmIChjb21wb25lbnQgIT09IG1lbnVDb21wb25lbnQpIHtcbiAgICAgICAgY29tcG9uZW50LmhpZGUoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6IFwibWRsLW1lbnVcIixcbiAgZXhwb3J0QXM6IFwibWRsTWVudVwiLFxuICB0ZW1wbGF0ZTogYFxuICAgIDxkaXYgI2NvbnRhaW5lciBjbGFzcz1cIm1kbC1tZW51X19jb250YWluZXIgaXMtdXBncmFkZWRcIj5cbiAgICAgIDxkaXYgI291dGxpbmUgY2xhc3M9XCJtZGwtbWVudV9fb3V0bGluZVwiIFtuZ0NsYXNzXT1cImNzc1Bvc2l0aW9uXCI+PC9kaXY+XG4gICAgICA8ZGl2IGNsYXNzPVwibWRsLW1lbnVcIiAjbWVudUVsZW1lbnQ+XG4gICAgICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbiAgICAgIDwvZGl2PlxuICAgIDwvZGl2PlxuICBgLFxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxufSlcbmV4cG9ydCBjbGFzcyBNZGxNZW51Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmVcbiAgQElucHV0KCdtZGwtbWVudS1wb3NpdGlvbicpXG4gIHBvc2l0aW9uOiBzdHJpbmc7XG5cbiAgQFZpZXdDaGlsZChcImNvbnRhaW5lclwiLCB7IHN0YXRpYzogdHJ1ZSB9KVxuICBjb250YWluZXJDaGlsZDogRWxlbWVudFJlZjtcbiAgQFZpZXdDaGlsZChcIm1lbnVFbGVtZW50XCIsIHsgc3RhdGljOiB0cnVlIH0pXG4gIG1lbnVFbGVtZW50Q2hpbGQ6IEVsZW1lbnRSZWY7XG4gIEBWaWV3Q2hpbGQoXCJvdXRsaW5lXCIsIHsgc3RhdGljOiB0cnVlIH0pXG4gIG91dGxpbmVDaGlsZDogRWxlbWVudFJlZjtcblxuICBwdWJsaWMgY3NzUG9zaXRpb24gPSBcIm1kbC1tZW51LS1ib3R0b20tbGVmdFwiO1xuICBwcml2YXRlIGNvbnRhaW5lcjogSFRNTEVsZW1lbnQ7XG4gIHByaXZhdGUgbWVudUVsZW1lbnQ6IEhUTUxFbGVtZW50O1xuICBwcml2YXRlIG91dGxpbmU6IEhUTUxFbGVtZW50O1xuICBwcml2YXRlIGlzVmlzaWJsZSA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMixcbiAgICBwcml2YXRlIG1lbnVSZWdpc3RyeTogTWRsTWVudVJlZ2lzdHlcbiAgKSB7XG4gICAgdGhpcy5tZW51UmVnaXN0cnkuYWRkKHRoaXMpO1xuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5jc3NQb3NpdGlvbiA9IENTU19BTElHTl9NQVBbdGhpcy5wb3NpdGlvbl0gfHwgQk9UVE9NX0xFRlQ7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgdGhpcy5jb250YWluZXIgPSB0aGlzLmNvbnRhaW5lckNoaWxkLm5hdGl2ZUVsZW1lbnQ7XG4gICAgdGhpcy5tZW51RWxlbWVudCA9IHRoaXMubWVudUVsZW1lbnRDaGlsZC5uYXRpdmVFbGVtZW50O1xuICAgIHRoaXMub3V0bGluZSA9IHRoaXMub3V0bGluZUNoaWxkLm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICAvLyBBZGQgYSBjbGljayBsaXN0ZW5lciB0byB0aGUgZG9jdW1lbnQsIHRvIGNsb3NlIHRoZSBtZW51LlxuICAgIGNvbnN0IGNhbGxiYWNrID0gKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuaXNWaXNpYmxlKSB7XG4gICAgICAgIHRoaXMuaGlkZSgpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfTtcbiAgICB0aGlzLnJlbmRlcmVyLmxpc3RlbihcIndpbmRvd1wiLCBcImNsaWNrXCIsIGNhbGxiYWNrKTtcbiAgICB0aGlzLnJlbmRlcmVyLmxpc3RlbihcIndpbmRvd1wiLCBcInRvdWNoc3RhcnRcIiwgY2FsbGJhY2spO1xuICB9XG5cbiAgdG9nZ2xlKGV2ZW50OiBFdmVudCwgbWRsQnV0dG9uOiBNZGxCdXR0b25Db21wb25lbnQpOiB2b2lkIHtcbiAgICBpZiAoIW1kbEJ1dHRvbikge1xuICAgICAgdGhyb3cgbmV3IE1kbE1lbnVFcnJvcihgTWRsQnV0dG9uQ29tcG9uZW50IGlzIHJlcXVpcmVkYCk7XG4gICAgfVxuICAgIGlmICh0aGlzLmlzVmlzaWJsZSkge1xuICAgICAgdGhpcy5oaWRlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2hvdyhldmVudCwgbWRsQnV0dG9uKTtcbiAgICB9XG4gIH1cblxuICBoaWRlT25JdGVtQ2xpY2tlZCgpOiB2b2lkIHtcbiAgICAvLyBXYWl0IHNvbWUgdGltZSBiZWZvcmUgY2xvc2luZyBtZW51LCBzbyB0aGUgdXNlciBjYW4gc2VlIHRoZSByaXBwbGUuXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLmhpZGUoKTtcbiAgICB9LCBDTE9TRV9USU1FT1VUKTtcbiAgfVxuXG4gIGhpZGUoKTogdm9pZCB7XG4gICAgLy8gUmVtb3ZlIGFsbCB0cmFuc2l0aW9uIGRlbGF5czsgbWVudSBpdGVtcyBmYWRlIG91dCBjb25jdXJyZW50bHkuXG4gICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIm1kbC1tZW51LWl0ZW1cIikuZm9yRWFjaCgoZWwpID0+IHtcbiAgICAgIChlbCBhcyBIVE1MRWxlbWVudCkuc3R5bGUucmVtb3ZlUHJvcGVydHkoXCJ0cmFuc2l0aW9uLWRlbGF5XCIpO1xuICAgIH0pO1xuICAgIC8vIHRoaXMubWVudUl0ZW1Db21wb25lbnRzLnRvQXJyYXkoKS5mb3JFYWNoKG1pID0+IHtcbiAgICAvLyAgIG1pLmVsZW1lbnQuc3R5bGUucmVtb3ZlUHJvcGVydHkoJ3RyYW5zaXRpb24tZGVsYXknKTtcbiAgICAvLyB9KTtcblxuICAgIC8vIE1lYXN1cmUgdGhlIGlubmVyIGVsZW1lbnQuXG4gICAgY29uc3QgcmVjdCA9IHRoaXMubWVudUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgY29uc3QgaGVpZ2h0ID0gcmVjdC5oZWlnaHQ7XG4gICAgY29uc3Qgd2lkdGggPSByZWN0LndpZHRoO1xuXG4gICAgLy8gVHVybiBvbiBhbmltYXRpb24sIGFuZCBhcHBseSB0aGUgZmluYWwgY2xpcC4gQWxzbyBtYWtlIGludmlzaWJsZS5cbiAgICAvLyBUaGlzIHRyaWdnZXJzIHRoZSB0cmFuc2l0aW9ucy5cbiAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMubWVudUVsZW1lbnQsIFwiaXMtYW5pbWF0aW5nXCIpO1xuICAgIHRoaXMuYXBwbHlDbGlwKGhlaWdodCwgd2lkdGgpO1xuICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy5jb250YWluZXIsIFwiaXMtdmlzaWJsZVwiKTtcblxuICAgIC8vIENsZWFuIHVwIGFmdGVyIHRoZSBhbmltYXRpb24gaXMgY29tcGxldGUuXG4gICAgdGhpcy5hZGRBbmltYXRpb25FbmRMaXN0ZW5lcigpO1xuXG4gICAgdGhpcy5pc1Zpc2libGUgPSBmYWxzZTtcbiAgfVxuXG4gIHNob3coZXZlbnQ6IEV2ZW50LCBtZGxCdXR0b246IE1kbEJ1dHRvbkNvbXBvbmVudCk6IHZvaWQge1xuICAgIHRoaXMubWVudVJlZ2lzdHJ5LmhpZGVBbGxFeGNlcHQodGhpcyk7XG5cbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgIGNvbnN0IGZvckVsZW1lbnQgPSBtZGxCdXR0b24uZWxlbWVudDtcbiAgICBjb25zdCByZWN0ID0gZm9yRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBjb25zdCBmb3JSZWN0ID0gZm9yRWxlbWVudC5wYXJlbnRFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuXG4gICAgaWYgKHRoaXMucG9zaXRpb24gPT09IFVOQUxJR05FRCkge1xuICAgICAgLy8gRG8gbm90IHBvc2l0aW9uIHRoZSBtZW51IGF1dG9tYXRpY2FsbHkuIFJlcXVpcmVzIHRoZSBkZXZlbG9wZXIgdG9cbiAgICAgIC8vIG1hbnVhbGx5IHNwZWNpZnkgcG9zaXRpb24uXG4gICAgfSBlbHNlIGlmICh0aGlzLnBvc2l0aW9uID09PSBCT1RUT01fUklHSFQpIHtcbiAgICAgIC8vIFBvc2l0aW9uIGJlbG93IHRoZSBcImZvclwiIGVsZW1lbnQsIGFsaWduZWQgdG8gaXRzIHJpZ2h0LlxuICAgICAgdGhpcy5jb250YWluZXIuc3R5bGUucmlnaHQgPSBmb3JSZWN0LnJpZ2h0IC0gcmVjdC5yaWdodCArIFwicHhcIjtcbiAgICAgIHRoaXMuY29udGFpbmVyLnN0eWxlLnRvcCA9XG4gICAgICAgIGZvckVsZW1lbnQub2Zmc2V0VG9wICsgZm9yRWxlbWVudC5vZmZzZXRIZWlnaHQgKyBcInB4XCI7XG4gICAgfSBlbHNlIGlmICh0aGlzLnBvc2l0aW9uID09PSBUT1BfTEVGVCkge1xuICAgICAgLy8gUG9zaXRpb24gYWJvdmUgdGhlIFwiZm9yXCIgZWxlbWVudCwgYWxpZ25lZCB0byBpdHMgbGVmdC5cbiAgICAgIHRoaXMuY29udGFpbmVyLnN0eWxlLmxlZnQgPSBmb3JFbGVtZW50Lm9mZnNldExlZnQgKyBcInB4XCI7XG4gICAgICB0aGlzLmNvbnRhaW5lci5zdHlsZS5ib3R0b20gPSBmb3JSZWN0LmJvdHRvbSAtIHJlY3QudG9wICsgXCJweFwiO1xuICAgIH0gZWxzZSBpZiAodGhpcy5wb3NpdGlvbiA9PT0gVE9QX1JJR0hUKSB7XG4gICAgICAvLyBQb3NpdGlvbiBhYm92ZSB0aGUgXCJmb3JcIiBlbGVtZW50LCBhbGlnbmVkIHRvIGl0cyByaWdodC5cbiAgICAgIHRoaXMuY29udGFpbmVyLnN0eWxlLnJpZ2h0ID0gZm9yUmVjdC5yaWdodCAtIHJlY3QucmlnaHQgKyBcInB4XCI7XG4gICAgICB0aGlzLmNvbnRhaW5lci5zdHlsZS5ib3R0b20gPSBmb3JSZWN0LmJvdHRvbSAtIHJlY3QudG9wICsgXCJweFwiO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBEZWZhdWx0OiBwb3NpdGlvbiBiZWxvdyB0aGUgXCJmb3JcIiBlbGVtZW50LCBhbGlnbmVkIHRvIGl0cyBsZWZ0LlxuICAgICAgdGhpcy5jb250YWluZXIuc3R5bGUubGVmdCA9IGZvckVsZW1lbnQub2Zmc2V0TGVmdCArIFwicHhcIjtcbiAgICAgIHRoaXMuY29udGFpbmVyLnN0eWxlLnRvcCA9XG4gICAgICAgIGZvckVsZW1lbnQub2Zmc2V0VG9wICsgZm9yRWxlbWVudC5vZmZzZXRIZWlnaHQgKyBcInB4XCI7XG4gICAgfVxuXG4gICAgLy8gTWVhc3VyZSB0aGUgaW5uZXIgZWxlbWVudC5cbiAgICBjb25zdCBoZWlnaHQgPSB0aGlzLm1lbnVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmhlaWdodDtcbiAgICBjb25zdCB3aWR0aCA9IHRoaXMubWVudUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGg7XG5cbiAgICB0aGlzLmNvbnRhaW5lci5zdHlsZS53aWR0aCA9IHdpZHRoICsgXCJweFwiO1xuICAgIHRoaXMuY29udGFpbmVyLnN0eWxlLmhlaWdodCA9IGhlaWdodCArIFwicHhcIjtcbiAgICB0aGlzLm91dGxpbmUuc3R5bGUud2lkdGggPSB3aWR0aCArIFwicHhcIjtcbiAgICB0aGlzLm91dGxpbmUuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgXCJweFwiO1xuXG4gICAgY29uc3QgdHJhbnNpdGlvbkR1cmF0aW9uID1cbiAgICAgIFRSQU5TSVRJT05fRFVSQVRJT05fU0VDT05EUyAqIFRSQU5TSVRJT05fRFVSQVRJT05fRlJBQ1RJT047XG4gICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIm1kbC1tZW51LWl0ZW1cIikuZm9yRWFjaCgoZWwpID0+IHtcbiAgICAgIGNvbnN0IG1pID0gZWwgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICBsZXQgaXRlbURlbGF5O1xuICAgICAgaWYgKHRoaXMucG9zaXRpb24gPT09IFRPUF9MRUZUIHx8IHRoaXMucG9zaXRpb24gPT09IFRPUF9SSUdIVCkge1xuICAgICAgICBpdGVtRGVsYXkgPVxuICAgICAgICAgICgoaGVpZ2h0IC0gbWkub2Zmc2V0VG9wIC0gbWkub2Zmc2V0SGVpZ2h0KSAvIGhlaWdodCkgKlxuICAgICAgICAgICAgdHJhbnNpdGlvbkR1cmF0aW9uICtcbiAgICAgICAgICBcInNcIjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGl0ZW1EZWxheSA9IChtaS5vZmZzZXRUb3AgLyBoZWlnaHQpICogdHJhbnNpdGlvbkR1cmF0aW9uICsgXCJzXCI7XG4gICAgICB9XG4gICAgICBtaS5zdHlsZS50cmFuc2l0aW9uRGVsYXkgPSBpdGVtRGVsYXk7XG4gICAgfSk7XG5cbiAgICAvLyBBcHBseSB0aGUgaW5pdGlhbCBjbGlwIHRvIHRoZSB0ZXh0IGJlZm9yZSB3ZSBzdGFydCBhbmltYXRpbmcuXG4gICAgdGhpcy5hcHBseUNsaXAoaGVpZ2h0LCB3aWR0aCk7XG5cbiAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMuY29udGFpbmVyLCBcImlzLXZpc2libGVcIik7XG4gICAgdGhpcy5tZW51RWxlbWVudC5zdHlsZS5jbGlwID0gXCJyZWN0KDAgXCIgKyB3aWR0aCArIFwicHggXCIgKyBoZWlnaHQgKyBcInB4IDApXCI7XG4gICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLm1lbnVFbGVtZW50LCBcImlzLWFuaW1hdGluZ1wiKTtcblxuICAgIHRoaXMuYWRkQW5pbWF0aW9uRW5kTGlzdGVuZXIoKTtcblxuICAgIHRoaXMuaXNWaXNpYmxlID0gdHJ1ZTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMubWVudVJlZ2lzdHJ5LnJlbW92ZSh0aGlzKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkQW5pbWF0aW9uRW5kTGlzdGVuZXIoKSB7XG4gICAgdGhpcy5yZW5kZXJlci5saXN0ZW4odGhpcy5tZW51RWxlbWVudCwgXCJ0cmFuc2l0aW9uZW5kXCIsICgpID0+IHtcbiAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy5tZW51RWxlbWVudCwgXCJpcy1hbmltYXRpbmdcIik7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXBwbHlDbGlwKGhlaWdodCwgd2lkdGgpIHtcbiAgICBpZiAodGhpcy5wb3NpdGlvbiA9PT0gVU5BTElHTkVEKSB7XG4gICAgICAvLyBEbyBub3QgY2xpcC5cbiAgICAgIHRoaXMubWVudUVsZW1lbnQuc3R5bGUuY2xpcCA9IFwiXCI7XG4gICAgfSBlbHNlIGlmICh0aGlzLnBvc2l0aW9uID09PSBCT1RUT01fUklHSFQpIHtcbiAgICAgIC8vIENsaXAgdG8gdGhlIHRvcCByaWdodCBjb3JuZXIgb2YgdGhlIG1lbnUuXG4gICAgICB0aGlzLm1lbnVFbGVtZW50LnN0eWxlLmNsaXAgPVxuICAgICAgICBcInJlY3QoMCBcIiArIHdpZHRoICsgXCJweCBcIiArIFwiMCBcIiArIHdpZHRoICsgXCJweClcIjtcbiAgICB9IGVsc2UgaWYgKHRoaXMucG9zaXRpb24gPT09IFRPUF9MRUZUKSB7XG4gICAgICAvLyBDbGlwIHRvIHRoZSBib3R0b20gbGVmdCBjb3JuZXIgb2YgdGhlIG1lbnUuXG4gICAgICB0aGlzLm1lbnVFbGVtZW50LnN0eWxlLmNsaXAgPVxuICAgICAgICBcInJlY3QoXCIgKyBoZWlnaHQgKyBcInB4IDAgXCIgKyBoZWlnaHQgKyBcInB4IDApXCI7XG4gICAgfSBlbHNlIGlmICh0aGlzLnBvc2l0aW9uID09PSBUT1BfUklHSFQpIHtcbiAgICAgIC8vIENsaXAgdG8gdGhlIGJvdHRvbSByaWdodCBjb3JuZXIgb2YgdGhlIG1lbnUuXG4gICAgICB0aGlzLm1lbnVFbGVtZW50LnN0eWxlLmNsaXAgPVxuICAgICAgICBcInJlY3QoXCIgK1xuICAgICAgICBoZWlnaHQgK1xuICAgICAgICBcInB4IFwiICtcbiAgICAgICAgd2lkdGggK1xuICAgICAgICBcInB4IFwiICtcbiAgICAgICAgaGVpZ2h0ICtcbiAgICAgICAgXCJweCBcIiArXG4gICAgICAgIHdpZHRoICtcbiAgICAgICAgXCJweClcIjtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gRGVmYXVsdDogZG8gbm90IGNsaXAgKHNhbWUgYXMgY2xpcHBpbmcgdG8gdGhlIHRvcCBsZWZ0IGNvcm5lcikuXG4gICAgICB0aGlzLm1lbnVFbGVtZW50LnN0eWxlLmNsaXAgPSBcIlwiO1xuICAgIH1cbiAgfVxufVxuIl19