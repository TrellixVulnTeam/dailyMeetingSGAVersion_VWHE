import { ComponentFactoryResolver, EventEmitter, Injectable, Injector, ViewContainerRef, } from "@angular/core";
import { Subject } from "rxjs";
import { MdlSimpleDialogComponent } from "./mdl-simple-dialog.component";
import { MdlDialogHostComponent } from "./mdl-dialog-host.component";
import { InternalMdlDialogReference } from "./internal-dialog-reference";
import { MdlDialogOutletService } from "../dialog-outlet/mdl-dialog-outlet.service";
import { MdlDialogReference } from "./mdl-dialog-reference";
import { MDL_CONFIGUARTION, MIN_DIALOG_Z_INDEX } from "./config";
import * as i0 from "@angular/core";
import * as i1 from "../dialog-outlet/mdl-dialog-outlet.service";
/**
 * The MdlDialogService is used to open different kind of dialogs. SimpleDialogs and Custom Dialogs.
 *
 * @experimental
 */
export class MdlDialogService {
    constructor(componentFactoryResolver, mdlDialogOutletService, injector) {
        this.componentFactoryResolver = componentFactoryResolver;
        this.mdlDialogOutletService = mdlDialogOutletService;
        this.injector = injector;
        /**
         * Emits an event when either all modals are closed, or one gets opened.
         *
         * @returns A subscribable event emitter that provides a boolean indicating whether a modal is open or not.
         */
        this.onDialogsOpenChanged = new EventEmitter();
        this.openDialogs = new Array();
        this.mdlDialogOutletService.backdropClickEmitter.subscribe(() => {
            this.onBackdropClick();
        });
    }
    /**
     * Shows a dialog that is just an alert - e.g. with one button.
     *
     * @param alertMessage The message that should be displayed.
     * @param okText The text that the button should have
     * @param title The optional title of the dialog
     * returns An Observable that is called if the user hits the Ok button.
     */
    alert(alertMessage, okText = "Ok", title) {
        const result = new Subject();
        this.showDialog({
            title,
            message: alertMessage,
            actions: [
                {
                    handler: () => {
                        result.next(null);
                        result.complete();
                    },
                    text: okText,
                },
            ],
            isModal: true,
        });
        return result;
    }
    /**
     * Shows a dialog that is just a confirm message - e.g. with two button.
     *
     * @param question The question that should be displayed.
     * @param title The title that should be displayed on top of Question.
     * @param declineText The text for decline button. defaults to Cancel
     * @param confirmText The text for the confirm button . defaults to Ok
     * returns An Observable that is called if the user hits the Ok button.
     */
    confirm(question, declineText = "Cancel", confirmText = "Ok", title) {
        const result = new Subject();
        this.showDialog({
            title,
            message: question,
            actions: [
                {
                    handler: () => {
                        result.next(null);
                        result.complete();
                    },
                    text: confirmText,
                },
                {
                    handler: () => {
                        result.error(null);
                    },
                    text: declineText,
                    isClosingAction: true,
                },
            ],
            isModal: true,
        });
        return result.asObservable();
    }
    /**
     * Shows a dialog that is specified by the provided configuration.
     *
     * @param config The simple dialog configuration.
     * returns An Observable that returns the MdlDialogReference.
     */
    showDialog(config) {
        if (config.actions.length === 0) {
            throw new Error("a dialog mus have at least one action");
        }
        const internalDialogRef = new InternalMdlDialogReference(config);
        const providers = [
            {
                provide: MdlDialogReference,
                useValue: new MdlDialogReference(internalDialogRef),
            },
            { provide: MDL_CONFIGUARTION, useValue: config },
        ];
        const hostComponentRef = this.createHostDialog(internalDialogRef, config);
        this.createComponentInstance(hostComponentRef.instance.dialogTarget, providers, MdlSimpleDialogComponent);
        return this.showHostDialog(internalDialogRef.dialogRef, hostComponentRef);
    }
    /**
     * Shows a dialog that is specified by the provided configuration.
     *
     * @param config The custom dialog configuration.
     * returns An Observable that returns the MdlDialogReference.
     */
    showCustomDialog(config) {
        const internalDialogRef = new InternalMdlDialogReference(config);
        const providers = [
            {
                provide: MdlDialogReference,
                useValue: new MdlDialogReference(internalDialogRef),
            },
        ];
        if (config.providers) {
            providers.push(...config.providers);
        }
        const hostComponentRef = this.createHostDialog(internalDialogRef, config);
        this.createComponentInstance(hostComponentRef.instance.dialogTarget, providers, config.component);
        return this.showHostDialog(internalDialogRef.dialogRef, hostComponentRef);
    }
    showDialogTemplate(template, config) {
        const internalDialogRef = new InternalMdlDialogReference(config);
        const hostComponentRef = this.createHostDialog(internalDialogRef, config);
        hostComponentRef.instance.dialogTarget.createEmbeddedView(template);
        return this.showHostDialog(internalDialogRef.dialogRef, hostComponentRef);
    }
    showHostDialog(dialogRef, hostComponentRef) {
        const result = new Subject();
        setTimeout(() => {
            result.next(dialogRef);
            result.complete();
            hostComponentRef.instance.show();
        });
        return result.asObservable();
    }
    createHostDialog(internalDialogRef, dialogConfig) {
        const viewContainerRef = this.mdlDialogOutletService.viewContainerRef;
        if (!viewContainerRef) {
            throw new Error("You did not provide a ViewContainerRef. " +
                "Please see https://github.com/mseemann/angular2-mdl/wiki/How-to-use-the-MdlDialogService");
        }
        const providers = [
            { provide: MDL_CONFIGUARTION, useValue: dialogConfig },
            { provide: InternalMdlDialogReference, useValue: internalDialogRef },
        ];
        const hostDialogComponent = this.createComponentInstance(viewContainerRef, providers, MdlDialogHostComponent);
        internalDialogRef.hostDialogComponentRef = hostDialogComponent;
        internalDialogRef.isModal = dialogConfig.isModal;
        internalDialogRef.closeCallback = () => {
            this.popDialog(internalDialogRef);
            hostDialogComponent.instance.hide(hostDialogComponent);
        };
        this.pushDialog(internalDialogRef);
        return hostDialogComponent;
    }
    pushDialog(dialogRef) {
        if (this.openDialogs.length === 0) {
            // first dialog being opened
            this.onDialogsOpenChanged.emit(true);
        }
        this.openDialogs.push(dialogRef);
        this.orderDialogStack();
    }
    popDialog(dialogRef) {
        this.openDialogs.splice(this.openDialogs.indexOf(dialogRef), 1);
        this.orderDialogStack();
        if (this.openDialogs.length === 0) {
            // last dialog being closed
            this.onDialogsOpenChanged.emit(false);
        }
    }
    orderDialogStack() {
        // +1 because the overlay may have MIN_DIALOG_Z_INDEX if the dialog is modal.
        let zIndex = MIN_DIALOG_Z_INDEX + 1;
        this.openDialogs.forEach((iDialogRef) => {
            iDialogRef.hostDialog.zIndex = zIndex;
            // +2 to make room for the overlay if a dialog is modal
            zIndex += 2;
        });
        this.mdlDialogOutletService.hideBackdrop();
        // if there is a modal dialog append the overloay to the dom - if not remove the overlay from the body
        const topMostModalDialog = this.getTopMostInternalDialogRef();
        if (topMostModalDialog) {
            // move the overlay diredct under the topmos modal dialog
            this.mdlDialogOutletService.showBackdropWithZIndex(topMostModalDialog.hostDialog.zIndex - 1);
        }
    }
    getTopMostInternalDialogRef() {
        let topMostModalDialog = null;
        for (let i = this.openDialogs.length - 1; i >= 0; i--) {
            if (this.openDialogs[i].isModal) {
                topMostModalDialog = this.openDialogs[i];
                break;
            }
        }
        return topMostModalDialog;
    }
    onBackdropClick() {
        const topMostModalDialog = this.getTopMostInternalDialogRef();
        if (topMostModalDialog.config.clickOutsideToClose) {
            topMostModalDialog.hide();
        }
    }
    createComponentInstance(viewContainerRef, providers, component) {
        const cFactory = this.componentFactoryResolver.resolveComponentFactory(component);
        const injector = Injector.create({
            providers: [
                ...providers,
                { provide: ViewContainerRef, useValue: viewContainerRef },
            ],
            parent: this.injector,
        });
        return viewContainerRef.createComponent(cFactory, viewContainerRef.length, injector);
    }
}
MdlDialogService.ɵprov = i0.ɵɵdefineInjectable({ factory: function MdlDialogService_Factory() { return new MdlDialogService(i0.ɵɵinject(i0.ComponentFactoryResolver), i0.ɵɵinject(i1.MdlDialogOutletService), i0.ɵɵinject(i0.INJECTOR)); }, token: MdlDialogService, providedIn: "root" });
MdlDialogService.decorators = [
    { type: Injectable, args: [{
                providedIn: "root",
            },] }
];
MdlDialogService.ctorParameters = () => [
    { type: ComponentFactoryResolver },
    { type: MdlDialogOutletService },
    { type: Injector }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWRsLWRpYWxvZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvY29yZS9zcmMvbGliL2RpYWxvZy9tZGwtZGlhbG9nLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLHdCQUF3QixFQUV4QixZQUFZLEVBQ1osVUFBVSxFQUNWLFFBQVEsRUFJUixnQkFBZ0IsR0FDakIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUzQyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQU1yRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUN6RSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQUNwRixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxVQUFVLENBQUM7OztBQUVqRTs7OztHQUlHO0FBS0gsTUFBTSxPQUFPLGdCQUFnQjtJQVUzQixZQUNVLHdCQUFrRCxFQUNsRCxzQkFBOEMsRUFDOUMsUUFBa0I7UUFGbEIsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtRQUNsRCwyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO1FBQzlDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFaNUI7Ozs7V0FJRztRQUNILHlCQUFvQixHQUEwQixJQUFJLFlBQVksRUFBVyxDQUFDO1FBRWxFLGdCQUFXLEdBQUcsSUFBSSxLQUFLLEVBQThCLENBQUM7UUFPNUQsSUFBSSxDQUFDLHNCQUFzQixDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7WUFDOUQs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QW9CakIsc0JBQXNCO1lBaEI3QixRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICBDb21wb25lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5qZWN0YWJsZSxcbiAgSW5qZWN0b3IsXG4gIFN0YXRpY1Byb3ZpZGVyLFxuICBUZW1wbGF0ZVJlZixcbiAgVHlwZSxcbiAgVmlld0NvbnRhaW5lclJlZixcbn0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tIFwicnhqc1wiO1xuXG5pbXBvcnQgeyBNZGxTaW1wbGVEaWFsb2dDb21wb25lbnQgfSBmcm9tIFwiLi9tZGwtc2ltcGxlLWRpYWxvZy5jb21wb25lbnRcIjtcbmltcG9ydCB7IE1kbERpYWxvZ0hvc3RDb21wb25lbnQgfSBmcm9tIFwiLi9tZGwtZGlhbG9nLWhvc3QuY29tcG9uZW50XCI7XG5pbXBvcnQge1xuICBJTWRsQ3VzdG9tRGlhbG9nQ29uZmlndXJhdGlvbixcbiAgSU1kbERpYWxvZ0NvbmZpZ3VyYXRpb24sXG4gIElNZGxTaW1wbGVEaWFsb2dDb25maWd1cmF0aW9uLFxufSBmcm9tIFwiLi9tZGwtZGlhbG9nLWNvbmZpZ3VyYXRpb25cIjtcbmltcG9ydCB7IEludGVybmFsTWRsRGlhbG9nUmVmZXJlbmNlIH0gZnJvbSBcIi4vaW50ZXJuYWwtZGlhbG9nLXJlZmVyZW5jZVwiO1xuaW1wb3J0IHsgTWRsRGlhbG9nT3V0bGV0U2VydmljZSB9IGZyb20gXCIuLi9kaWFsb2ctb3V0bGV0L21kbC1kaWFsb2ctb3V0bGV0LnNlcnZpY2VcIjtcbmltcG9ydCB7IE1kbERpYWxvZ1JlZmVyZW5jZSB9IGZyb20gXCIuL21kbC1kaWFsb2ctcmVmZXJlbmNlXCI7XG5pbXBvcnQgeyBNRExfQ09ORklHVUFSVElPTiwgTUlOX0RJQUxPR19aX0lOREVYIH0gZnJvbSBcIi4vY29uZmlnXCI7XG5cbi8qKlxuICogVGhlIE1kbERpYWxvZ1NlcnZpY2UgaXMgdXNlZCB0byBvcGVuIGRpZmZlcmVudCBraW5kIG9mIGRpYWxvZ3MuIFNpbXBsZURpYWxvZ3MgYW5kIEN1c3RvbSBEaWFsb2dzLlxuICpcbiAqIEBleHBlcmltZW50YWxcbiAqL1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46IFwicm9vdFwiLFxufSlcbmV4cG9ydCBjbGFzcyBNZGxEaWFsb2dTZXJ2aWNlIHtcbiAgLyoqXG4gICAqIEVtaXRzIGFuIGV2ZW50IHdoZW4gZWl0aGVyIGFsbCBtb2RhbHMgYXJlIGNsb3NlZCwgb3Igb25lIGdldHMgb3BlbmVkLlxuICAgKlxuICAgKiBAcmV0dXJucyBBIHN1YnNjcmliYWJsZSBldmVudCBlbWl0dGVyIHRoYXQgcHJvdmlkZXMgYSBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciBhIG1vZGFsIGlzIG9wZW4gb3Igbm90LlxuICAgKi9cbiAgb25EaWFsb2dzT3BlbkNoYW5nZWQ6IEV2ZW50RW1pdHRlcjxib29sZWFuPiA9IG5ldyBFdmVudEVtaXR0ZXI8Ym9vbGVhbj4oKTtcblxuICBwcml2YXRlIG9wZW5EaWFsb2dzID0gbmV3IEFycmF5PEludGVybmFsTWRsRGlhbG9nUmVmZXJlbmNlPigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSBtZGxEaWFsb2dPdXRsZXRTZXJ2aWNlOiBNZGxEaWFsb2dPdXRsZXRTZXJ2aWNlLFxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yXG4gICkge1xuICAgIHRoaXMubWRsRGlhbG9nT3V0bGV0U2VydmljZS5iYWNrZHJvcENsaWNrRW1pdHRlci5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5vbkJhY2tkcm9wQ2xpY2soKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTaG93cyBhIGRpYWxvZyB0aGF0IGlzIGp1c3QgYW4gYWxlcnQgLSBlLmcuIHdpdGggb25lIGJ1dHRvbi5cbiAgICpcbiAgICogQHBhcmFtIGFsZXJ0TWVzc2FnZSBUaGUgbWVzc2FnZSB0aGF0IHNob3VsZCBiZSBkaXNwbGF5ZWQuXG4gICAqIEBwYXJhbSBva1RleHQgVGhlIHRleHQgdGhhdCB0aGUgYnV0dG9uIHNob3VsZCBoYXZlXG4gICAqIEBwYXJhbSB0aXRsZSBUaGUgb3B0aW9uYWwgdGl0bGUgb2YgdGhlIGRpYWxvZ1xuICAgKiByZXR1cm5zIEFuIE9ic2VydmFibGUgdGhhdCBpcyBjYWxsZWQgaWYgdGhlIHVzZXIgaGl0cyB0aGUgT2sgYnV0dG9uLlxuICAgKi9cbiAgcHVibGljIGFsZXJ0KFxuICAgIGFsZXJ0TWVzc2FnZTogc3RyaW5nLFxuICAgIG9rVGV4dCA9IFwiT2tcIixcbiAgICB0aXRsZT86IHN0cmluZ1xuICApOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICBjb25zdCByZXN1bHQ6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdCgpO1xuXG4gICAgdGhpcy5zaG93RGlhbG9nKHtcbiAgICAgIHRpdGxlLFxuICAgICAgbWVzc2FnZTogYWxlcnRNZXNzYWdlLFxuICAgICAgYWN0aW9uczogW1xuICAgICAgICB7XG4gICAgICAgICAgaGFuZGxlcjogKCkgPT4ge1xuICAgICAgICAgICAgcmVzdWx0Lm5leHQobnVsbCk7XG4gICAgICAgICAgICByZXN1bHQuY29tcGxldGUoKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRleHQ6IG9rVGV4dCxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBpc01vZGFsOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTaG93cyBhIGRpYWxvZyB0aGF0IGlzIGp1c3QgYSBjb25maXJtIG1lc3NhZ2UgLSBlLmcuIHdpdGggdHdvIGJ1dHRvbi5cbiAgICpcbiAgICogQHBhcmFtIHF1ZXN0aW9uIFRoZSBxdWVzdGlvbiB0aGF0IHNob3VsZCBiZSBkaXNwbGF5ZWQuXG4gICAqIEBwYXJhbSB0aXRsZSBUaGUgdGl0bGUgdGhhdCBzaG91bGQgYmUgZGlzcGxheWVkIG9uIHRvcCBvZiBRdWVzdGlvbi5cbiAgICogQHBhcmFtIGRlY2xpbmVUZXh0IFRoZSB0ZXh0IGZvciBkZWNsaW5lIGJ1dHRvbi4gZGVmYXVsdHMgdG8gQ2FuY2VsXG4gICAqIEBwYXJhbSBjb25maXJtVGV4dCBUaGUgdGV4dCBmb3IgdGhlIGNvbmZpcm0gYnV0dG9uIC4gZGVmYXVsdHMgdG8gT2tcbiAgICogcmV0dXJucyBBbiBPYnNlcnZhYmxlIHRoYXQgaXMgY2FsbGVkIGlmIHRoZSB1c2VyIGhpdHMgdGhlIE9rIGJ1dHRvbi5cbiAgICovXG4gIHB1YmxpYyBjb25maXJtKFxuICAgIHF1ZXN0aW9uOiBzdHJpbmcsXG4gICAgZGVjbGluZVRleHQgPSBcIkNhbmNlbFwiLFxuICAgIGNvbmZpcm1UZXh0ID0gXCJPa1wiLFxuICAgIHRpdGxlPzogc3RyaW5nXG4gICk6IE9ic2VydmFibGU8dm9pZD4ge1xuICAgIGNvbnN0IHJlc3VsdDogU3ViamVjdDx2b2lkPiA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgICB0aGlzLnNob3dEaWFsb2coe1xuICAgICAgdGl0bGUsXG4gICAgICBtZXNzYWdlOiBxdWVzdGlvbixcbiAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAge1xuICAgICAgICAgIGhhbmRsZXI6ICgpID0+IHtcbiAgICAgICAgICAgIHJlc3VsdC5uZXh0KG51bGwpO1xuICAgICAgICAgICAgcmVzdWx0LmNvbXBsZXRlKCk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICB0ZXh0OiBjb25maXJtVGV4dCxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGhhbmRsZXI6ICgpID0+IHtcbiAgICAgICAgICAgIHJlc3VsdC5lcnJvcihudWxsKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRleHQ6IGRlY2xpbmVUZXh0LFxuICAgICAgICAgIGlzQ2xvc2luZ0FjdGlvbjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBpc01vZGFsOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJlc3VsdC5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTaG93cyBhIGRpYWxvZyB0aGF0IGlzIHNwZWNpZmllZCBieSB0aGUgcHJvdmlkZWQgY29uZmlndXJhdGlvbi5cbiAgICpcbiAgICogQHBhcmFtIGNvbmZpZyBUaGUgc2ltcGxlIGRpYWxvZyBjb25maWd1cmF0aW9uLlxuICAgKiByZXR1cm5zIEFuIE9ic2VydmFibGUgdGhhdCByZXR1cm5zIHRoZSBNZGxEaWFsb2dSZWZlcmVuY2UuXG4gICAqL1xuICBwdWJsaWMgc2hvd0RpYWxvZyhcbiAgICBjb25maWc6IElNZGxTaW1wbGVEaWFsb2dDb25maWd1cmF0aW9uXG4gICk6IE9ic2VydmFibGU8TWRsRGlhbG9nUmVmZXJlbmNlPiB7XG4gICAgaWYgKGNvbmZpZy5hY3Rpb25zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiYSBkaWFsb2cgbXVzIGhhdmUgYXQgbGVhc3Qgb25lIGFjdGlvblwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnRlcm5hbERpYWxvZ1JlZiA9IG5ldyBJbnRlcm5hbE1kbERpYWxvZ1JlZmVyZW5jZShjb25maWcpO1xuXG4gICAgY29uc3QgcHJvdmlkZXJzID0gW1xuICAgICAge1xuICAgICAgICBwcm92aWRlOiBNZGxEaWFsb2dSZWZlcmVuY2UsXG4gICAgICAgIHVzZVZhbHVlOiBuZXcgTWRsRGlhbG9nUmVmZXJlbmNlKGludGVybmFsRGlhbG9nUmVmKSxcbiAgICAgIH0sXG4gICAgICB7IHByb3ZpZGU6IE1ETF9DT05GSUdVQVJUSU9OLCB1c2VWYWx1ZTogY29uZmlnIH0sXG4gICAgXTtcblxuICAgIGNvbnN0IGhvc3RDb21wb25lbnRSZWYgPSB0aGlzLmNyZWF0ZUhvc3REaWFsb2coaW50ZXJuYWxEaWFsb2dSZWYsIGNvbmZpZyk7XG5cbiAgICB0aGlzLmNyZWF0ZUNvbXBvbmVudEluc3RhbmNlKFxuICAgICAgaG9zdENvbXBvbmVudFJlZi5pbnN0YW5jZS5kaWFsb2dUYXJnZXQsXG4gICAgICBwcm92aWRlcnMsXG4gICAgICBNZGxTaW1wbGVEaWFsb2dDb21wb25lbnRcbiAgICApO1xuXG4gICAgcmV0dXJuIHRoaXMuc2hvd0hvc3REaWFsb2coaW50ZXJuYWxEaWFsb2dSZWYuZGlhbG9nUmVmLCBob3N0Q29tcG9uZW50UmVmKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTaG93cyBhIGRpYWxvZyB0aGF0IGlzIHNwZWNpZmllZCBieSB0aGUgcHJvdmlkZWQgY29uZmlndXJhdGlvbi5cbiAgICpcbiAgICogQHBhcmFtIGNvbmZpZyBUaGUgY3VzdG9tIGRpYWxvZyBjb25maWd1cmF0aW9uLlxuICAgKiByZXR1cm5zIEFuIE9ic2VydmFibGUgdGhhdCByZXR1cm5zIHRoZSBNZGxEaWFsb2dSZWZlcmVuY2UuXG4gICAqL1xuICBwdWJsaWMgc2hvd0N1c3RvbURpYWxvZyhcbiAgICBjb25maWc6IElNZGxDdXN0b21EaWFsb2dDb25maWd1cmF0aW9uXG4gICk6IE9ic2VydmFibGU8TWRsRGlhbG9nUmVmZXJlbmNlPiB7XG4gICAgY29uc3QgaW50ZXJuYWxEaWFsb2dSZWYgPSBuZXcgSW50ZXJuYWxNZGxEaWFsb2dSZWZlcmVuY2UoY29uZmlnKTtcblxuICAgIGNvbnN0IHByb3ZpZGVyczogU3RhdGljUHJvdmlkZXJbXSA9IFtcbiAgICAgIHtcbiAgICAgICAgcHJvdmlkZTogTWRsRGlhbG9nUmVmZXJlbmNlLFxuICAgICAgICB1c2VWYWx1ZTogbmV3IE1kbERpYWxvZ1JlZmVyZW5jZShpbnRlcm5hbERpYWxvZ1JlZiksXG4gICAgICB9LFxuICAgIF07XG5cbiAgICBpZiAoY29uZmlnLnByb3ZpZGVycykge1xuICAgICAgcHJvdmlkZXJzLnB1c2goLi4uY29uZmlnLnByb3ZpZGVycyk7XG4gICAgfVxuXG4gICAgY29uc3QgaG9zdENvbXBvbmVudFJlZiA9IHRoaXMuY3JlYXRlSG9zdERpYWxvZyhpbnRlcm5hbERpYWxvZ1JlZiwgY29uZmlnKTtcblxuICAgIHRoaXMuY3JlYXRlQ29tcG9uZW50SW5zdGFuY2UoXG4gICAgICBob3N0Q29tcG9uZW50UmVmLmluc3RhbmNlLmRpYWxvZ1RhcmdldCxcbiAgICAgIHByb3ZpZGVycyxcbiAgICAgIGNvbmZpZy5jb21wb25lbnRcbiAgICApO1xuXG4gICAgcmV0dXJuIHRoaXMuc2hvd0hvc3REaWFsb2coaW50ZXJuYWxEaWFsb2dSZWYuZGlhbG9nUmVmLCBob3N0Q29tcG9uZW50UmVmKTtcbiAgfVxuXG4gIHB1YmxpYyBzaG93RGlhbG9nVGVtcGxhdGUoXG4gICAgdGVtcGxhdGU6IFRlbXBsYXRlUmVmPHVua25vd24+LFxuICAgIGNvbmZpZzogSU1kbERpYWxvZ0NvbmZpZ3VyYXRpb25cbiAgKTogT2JzZXJ2YWJsZTxNZGxEaWFsb2dSZWZlcmVuY2U+IHtcbiAgICBjb25zdCBpbnRlcm5hbERpYWxvZ1JlZiA9IG5ldyBJbnRlcm5hbE1kbERpYWxvZ1JlZmVyZW5jZShjb25maWcpO1xuXG4gICAgY29uc3QgaG9zdENvbXBvbmVudFJlZiA9IHRoaXMuY3JlYXRlSG9zdERpYWxvZyhpbnRlcm5hbERpYWxvZ1JlZiwgY29uZmlnKTtcblxuICAgIGhvc3RDb21wb25lbnRSZWYuaW5zdGFuY2UuZGlhbG9nVGFyZ2V0LmNyZWF0ZUVtYmVkZGVkVmlldyh0ZW1wbGF0ZSk7XG5cbiAgICByZXR1cm4gdGhpcy5zaG93SG9zdERpYWxvZyhpbnRlcm5hbERpYWxvZ1JlZi5kaWFsb2dSZWYsIGhvc3RDb21wb25lbnRSZWYpO1xuICB9XG5cbiAgcHJpdmF0ZSBzaG93SG9zdERpYWxvZyhcbiAgICBkaWFsb2dSZWY6IE1kbERpYWxvZ1JlZmVyZW5jZSxcbiAgICBob3N0Q29tcG9uZW50UmVmOiBDb21wb25lbnRSZWY8TWRsRGlhbG9nSG9zdENvbXBvbmVudD5cbiAgKSB7XG4gICAgY29uc3QgcmVzdWx0OiBTdWJqZWN0PE1kbERpYWxvZ1JlZmVyZW5jZT4gPSBuZXcgU3ViamVjdCgpO1xuXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICByZXN1bHQubmV4dChkaWFsb2dSZWYpO1xuICAgICAgcmVzdWx0LmNvbXBsZXRlKCk7XG4gICAgICBob3N0Q29tcG9uZW50UmVmLmluc3RhbmNlLnNob3coKTtcbiAgICB9KTtcblxuICAgIHJldHVybiByZXN1bHQuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUhvc3REaWFsb2coXG4gICAgaW50ZXJuYWxEaWFsb2dSZWY6IEludGVybmFsTWRsRGlhbG9nUmVmZXJlbmNlLFxuICAgIGRpYWxvZ0NvbmZpZzogSU1kbERpYWxvZ0NvbmZpZ3VyYXRpb25cbiAgKSB7XG4gICAgY29uc3Qgdmlld0NvbnRhaW5lclJlZiA9IHRoaXMubWRsRGlhbG9nT3V0bGV0U2VydmljZS52aWV3Q29udGFpbmVyUmVmO1xuICAgIGlmICghdmlld0NvbnRhaW5lclJlZikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBcIllvdSBkaWQgbm90IHByb3ZpZGUgYSBWaWV3Q29udGFpbmVyUmVmLiBcIiArXG4gICAgICAgICAgXCJQbGVhc2Ugc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9tc2VlbWFubi9hbmd1bGFyMi1tZGwvd2lraS9Ib3ctdG8tdXNlLXRoZS1NZGxEaWFsb2dTZXJ2aWNlXCJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgcHJvdmlkZXJzOiBTdGF0aWNQcm92aWRlcltdID0gW1xuICAgICAgeyBwcm92aWRlOiBNRExfQ09ORklHVUFSVElPTiwgdXNlVmFsdWU6IGRpYWxvZ0NvbmZpZyB9LFxuICAgICAgeyBwcm92aWRlOiBJbnRlcm5hbE1kbERpYWxvZ1JlZmVyZW5jZSwgdXNlVmFsdWU6IGludGVybmFsRGlhbG9nUmVmIH0sXG4gICAgXTtcblxuICAgIGNvbnN0IGhvc3REaWFsb2dDb21wb25lbnQgPSB0aGlzLmNyZWF0ZUNvbXBvbmVudEluc3RhbmNlKFxuICAgICAgdmlld0NvbnRhaW5lclJlZixcbiAgICAgIHByb3ZpZGVycyxcbiAgICAgIE1kbERpYWxvZ0hvc3RDb21wb25lbnRcbiAgICApO1xuXG4gICAgaW50ZXJuYWxEaWFsb2dSZWYuaG9zdERpYWxvZ0NvbXBvbmVudFJlZiA9IGhvc3REaWFsb2dDb21wb25lbnQ7XG4gICAgaW50ZXJuYWxEaWFsb2dSZWYuaXNNb2RhbCA9IGRpYWxvZ0NvbmZpZy5pc01vZGFsO1xuXG4gICAgaW50ZXJuYWxEaWFsb2dSZWYuY2xvc2VDYWxsYmFjayA9ICgpID0+IHtcbiAgICAgIHRoaXMucG9wRGlhbG9nKGludGVybmFsRGlhbG9nUmVmKTtcbiAgICAgIGhvc3REaWFsb2dDb21wb25lbnQuaW5zdGFuY2UuaGlkZShob3N0RGlhbG9nQ29tcG9uZW50KTtcbiAgICB9O1xuICAgIHRoaXMucHVzaERpYWxvZyhpbnRlcm5hbERpYWxvZ1JlZik7XG5cbiAgICByZXR1cm4gaG9zdERpYWxvZ0NvbXBvbmVudDtcbiAgfVxuXG4gIHByaXZhdGUgcHVzaERpYWxvZyhkaWFsb2dSZWY6IEludGVybmFsTWRsRGlhbG9nUmVmZXJlbmNlKSB7XG4gICAgaWYgKHRoaXMub3BlbkRpYWxvZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAvLyBmaXJzdCBkaWFsb2cgYmVpbmcgb3BlbmVkXG4gICAgICB0aGlzLm9uRGlhbG9nc09wZW5DaGFuZ2VkLmVtaXQodHJ1ZSk7XG4gICAgfVxuXG4gICAgdGhpcy5vcGVuRGlhbG9ncy5wdXNoKGRpYWxvZ1JlZik7XG4gICAgdGhpcy5vcmRlckRpYWxvZ1N0YWNrKCk7XG4gIH1cblxuICBwcml2YXRlIHBvcERpYWxvZyhkaWFsb2dSZWY6IEludGVybmFsTWRsRGlhbG9nUmVmZXJlbmNlKSB7XG4gICAgdGhpcy5vcGVuRGlhbG9ncy5zcGxpY2UodGhpcy5vcGVuRGlhbG9ncy5pbmRleE9mKGRpYWxvZ1JlZiksIDEpO1xuICAgIHRoaXMub3JkZXJEaWFsb2dTdGFjaygpO1xuXG4gICAgaWYgKHRoaXMub3BlbkRpYWxvZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAvLyBsYXN0IGRpYWxvZyBiZWluZyBjbG9zZWRcbiAgICAgIHRoaXMub25EaWFsb2dzT3BlbkNoYW5nZWQuZW1pdChmYWxzZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvcmRlckRpYWxvZ1N0YWNrKCkge1xuICAgIC8vICsxIGJlY2F1c2UgdGhlIG92ZXJsYXkgbWF5IGhhdmUgTUlOX0RJQUxPR19aX0lOREVYIGlmIHRoZSBkaWFsb2cgaXMgbW9kYWwuXG4gICAgbGV0IHpJbmRleCA9IE1JTl9ESUFMT0dfWl9JTkRFWCArIDE7XG5cbiAgICB0aGlzLm9wZW5EaWFsb2dzLmZvckVhY2goKGlEaWFsb2dSZWYpID0+IHtcbiAgICAgIGlEaWFsb2dSZWYuaG9zdERpYWxvZy56SW5kZXggPSB6SW5kZXg7XG4gICAgICAvLyArMiB0byBtYWtlIHJvb20gZm9yIHRoZSBvdmVybGF5IGlmIGEgZGlhbG9nIGlzIG1vZGFsXG4gICAgICB6SW5kZXggKz0gMjtcbiAgICB9KTtcblxuICAgIHRoaXMubWRsRGlhbG9nT3V0bGV0U2VydmljZS5oaWRlQmFja2Ryb3AoKTtcblxuICAgIC8vIGlmIHRoZXJlIGlzIGEgbW9kYWwgZGlhbG9nIGFwcGVuZCB0aGUgb3ZlcmxvYXkgdG8gdGhlIGRvbSAtIGlmIG5vdCByZW1vdmUgdGhlIG92ZXJsYXkgZnJvbSB0aGUgYm9keVxuICAgIGNvbnN0IHRvcE1vc3RNb2RhbERpYWxvZzogSW50ZXJuYWxNZGxEaWFsb2dSZWZlcmVuY2UgPSB0aGlzLmdldFRvcE1vc3RJbnRlcm5hbERpYWxvZ1JlZigpO1xuICAgIGlmICh0b3BNb3N0TW9kYWxEaWFsb2cpIHtcbiAgICAgIC8vIG1vdmUgdGhlIG92ZXJsYXkgZGlyZWRjdCB1bmRlciB0aGUgdG9wbW9zIG1vZGFsIGRpYWxvZ1xuICAgICAgdGhpcy5tZGxEaWFsb2dPdXRsZXRTZXJ2aWNlLnNob3dCYWNrZHJvcFdpdGhaSW5kZXgoXG4gICAgICAgIHRvcE1vc3RNb2RhbERpYWxvZy5ob3N0RGlhbG9nLnpJbmRleCAtIDFcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRUb3BNb3N0SW50ZXJuYWxEaWFsb2dSZWYoKTogSW50ZXJuYWxNZGxEaWFsb2dSZWZlcmVuY2Uge1xuICAgIGxldCB0b3BNb3N0TW9kYWxEaWFsb2c6IEludGVybmFsTWRsRGlhbG9nUmVmZXJlbmNlID0gbnVsbDtcblxuICAgIGZvciAobGV0IGkgPSB0aGlzLm9wZW5EaWFsb2dzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBpZiAodGhpcy5vcGVuRGlhbG9nc1tpXS5pc01vZGFsKSB7XG4gICAgICAgIHRvcE1vc3RNb2RhbERpYWxvZyA9IHRoaXMub3BlbkRpYWxvZ3NbaV07XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdG9wTW9zdE1vZGFsRGlhbG9nO1xuICB9XG5cbiAgcHJpdmF0ZSBvbkJhY2tkcm9wQ2xpY2soKSB7XG4gICAgY29uc3QgdG9wTW9zdE1vZGFsRGlhbG9nOiBJbnRlcm5hbE1kbERpYWxvZ1JlZmVyZW5jZSA9IHRoaXMuZ2V0VG9wTW9zdEludGVybmFsRGlhbG9nUmVmKCk7XG4gICAgaWYgKHRvcE1vc3RNb2RhbERpYWxvZy5jb25maWcuY2xpY2tPdXRzaWRlVG9DbG9zZSkge1xuICAgICAgdG9wTW9zdE1vZGFsRGlhbG9nLmhpZGUoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNvbXBvbmVudEluc3RhbmNlPFQ+KFxuICAgIHZpZXdDb250YWluZXJSZWY6IFZpZXdDb250YWluZXJSZWYsXG4gICAgcHJvdmlkZXJzOiBTdGF0aWNQcm92aWRlcltdLFxuICAgIGNvbXBvbmVudDogVHlwZTxUPlxuICApOiBDb21wb25lbnRSZWY8VD4ge1xuICAgIGNvbnN0IGNGYWN0b3J5ID0gdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoXG4gICAgICBjb21wb25lbnRcbiAgICApO1xuXG4gICAgY29uc3QgaW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIC4uLnByb3ZpZGVycyxcbiAgICAgICAgeyBwcm92aWRlOiBWaWV3Q29udGFpbmVyUmVmLCB1c2VWYWx1ZTogdmlld0NvbnRhaW5lclJlZiB9LFxuICAgICAgXSxcbiAgICAgIHBhcmVudDogdGhpcy5pbmplY3RvcixcbiAgICB9KTtcblxuICAgIHJldHVybiB2aWV3Q29udGFpbmVyUmVmLmNyZWF0ZUNvbXBvbmVudChcbiAgICAgIGNGYWN0b3J5LFxuICAgICAgdmlld0NvbnRhaW5lclJlZi5sZW5ndGgsXG4gICAgICBpbmplY3RvclxuICAgICk7XG4gIH1cbn1cbiJdfQ==